<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMG Management UI</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        :root {
            --amg-primary: #0d6efd;
            --amg-dark: #212529;
            --amg-light: #f8f9fa;
        }
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar {
            background-color: var(--amg-dark);
            min-height: 100vh;
            color: white;
        }
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255,255,255,0.1);
        }
        .sidebar .nav-link i {
            margin-right: 10px;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-weight: 600;
        }
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .navbar {
            background-color: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .badge-pii { background-color: #dc3545; }
        .badge-non_pii { background-color: #198754; }
        .badge-long_term { background-color: #0dcaf0; }
        .badge-short_term { background-color: #6c757d; }
        .badge-episodic { background-color: #ffc107; color: black; }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-online { background-color: #198754; }
        .status-offline { background-color: #dc3545; }
        .status-frozen { background-color: #ffc107; }

        #api-key-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .audit-table-container {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <!-- API Key Entry Modal -->
    <div id="api-key-overlay">
        <div class="card p-4" style="width: 400px;">
            <div class="text-center mb-4">
                <i class="bi bi-shield-lock-fill text-primary" style="font-size: 3rem;"></i>
                <h4>AMG Management</h4>
                <p class="text-muted small">Enter your Operator API Key to access governance controls</p>
            </div>
            <div class="mb-3">
                <input type="password" id="api-key-input" class="form-control" placeholder="sk-...">
            </div>
            <button class="btn btn-primary w-100" onclick="saveApiKey()">Authenticate</button>
        </div>
    </div>

    <div class="container-fluid p-0">
        <div class="row g-0">
            <!-- Sidebar -->
            <div class="col-md-2 d-none d-md-block sidebar p-3">
                <div class="d-flex align-items-center mb-4 px-2">
                    <i class="bi bi-memory text-primary me-2" style="font-size: 1.5rem;"></i>
                    <h5 class="m-0 fw-bold">AMG <span class="text-primary">Plane</span></h5>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showTab('dashboard')">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTab('agents')">
                            <i class="bi bi-robot"></i> Agents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTab('audit')">
                            <i class="bi bi-list-check"></i> Audit Logs
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showTab('policies')">
                            <i class="bi bi-journal-text"></i> Policies
                        </a>
                    </li>
                    <hr class="mt-4 mb-3 border-secondary">
                    <li class="nav-item">
                        <a class="nav-link text-danger" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-left"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="col-md-10">
                <!-- Top Navbar -->
                <nav class="navbar navbar-expand-lg navbar-light px-4">
                    <div class="container-fluid">
                        <span class="navbar-brand mb-0 h1 fs-6 text-muted">Management Console</span>
                        <div class="d-flex align-items-center">
                            <div class="me-3 text-end d-none d-sm-block">
                                <div class="small fw-semibold" id="cert-status-text">Cert: Valid</div>
                                <div class="text-muted" style="font-size: 0.7rem;" id="cert-expiry">Expires in 89 days</div>
                            </div>
                            <div class="status-indicator status-online"></div>
                            <span class="small fw-bold">Live</span>
                        </div>
                    </div>
                </nav>

                <div id="content-dashboard" class="p-4 tab-content">
                    <div class="row align-items-center mb-4">
                        <div class="col-6">
                            <h3 class="fw-bold m-0 text-dark">System Overview</h3>
                        </div>
                        <div class="col-6 text-end">
                            <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshAllData()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="triggerGlobalShutdown()">
                                <i class="bi bi-power"></i> Global Shutdown
                            </button>
                        </div>
                    </div>

                    <!-- Stats Row -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card stat-card text-center p-3">
                                <p class="text-muted small mb-1">Total Memories</p>
                                <h2 class="fw-bold mb-0" id="stat-total-memories">0</h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card text-center p-3">
                                <p class="text-muted small mb-1">Active Agents</p>
                                <h2 class="fw-bold mb-0" id="stat-active-agents">0</h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card text-center p-3">
                                <p class="text-muted small mb-1">Audit Events (24h)</p>
                                <h2 class="fw-bold mb-0" id="stat-audit-events">0</h2>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card stat-card text-center p-3 border-start border-danger border-4">
                                <p class="text-muted small mb-1">Denied Ops</p>
                                <h2 class="fw-bold mb-0 text-danger" id="stat-denied-ops">0</h2>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Distribution Charts -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Memory Distribution</span>
                                    <i class="bi bi-pie-chart text-muted"></i>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between small mb-1">
                                            <span>Long-term</span>
                                            <span id="dist-lt-text">0%</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div id="dist-lt-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between small mb-1">
                                            <span>Short-term</span>
                                            <span id="dist-st-text">0%</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div id="dist-st-bar" class="progress-bar bg-secondary" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between small mb-1">
                                            <span>Episodic</span>
                                            <span id="dist-ep-text">0%</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div id="dist-ep-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row text-center mt-3">
                                        <div class="col-6 border-end">
                                            <h4 class="fw-bold mb-0" id="dist-pii-count">0</h4>
                                            <span class="badge badge-pii">PII Items</span>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="fw-bold mb-0" id="dist-nonpii-count">0</h4>
                                            <span class="badge badge-non_pii">Non-PII</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Agents -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Recent Activity</span>
                                    <i class="bi bi-activity text-muted"></i>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush" id="recent-activity-list">
                                        <li class="list-group-item text-center text-muted py-5">Loading activity...</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Audit Table -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Recent Audit Events</span>
                            <a href="#" onclick="showTab('audit')" class="text-primary small">View all</a>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Agent</th>
                                            <th>Action</th>
                                            <th>Decision</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody id="home-audit-tbody">
                                        <tr><td colspan="5" class="text-center py-4">Loading audit logs...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agents Tab -->
                <div id="content-agents" class="p-4 tab-content d-none">
                    <div class="row align-items-center mb-4">
                        <div class="col-6">
                            <h3 class="fw-bold m-0">Agent Governance</h3>
                        </div>
                        <div class="col-6 text-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="fetchAgents()">Refresh Agents</button>
                        </div>
                    </div>
                    
                    <div class="row g-3" id="agents-grid">
                        <!-- Agent Card Placeholder -->
                        <div class="col-12 text-center py-5 text-muted">Loading agent list...</div>
                    </div>
                </div>

                <!-- Audit Logs Tab -->
                <div id="content-audit" class="p-4 tab-content d-none">
                    <h3 class="fw-bold mb-4">Security Audit Explorer</h3>
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label small fw-bold">Agent ID</label>
                                    <input type="text" id="filter-agent" class="form-control" placeholder="Filter by agent...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold">Operation</label>
                                    <select id="filter-op" class="form-control">
                                        <option value="">All Operations</option>
                                        <option value="write">Write</option>
                                        <option value="read">Read</option>
                                        <option value="query">Query</option>
                                        <option value="disable">Disable</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small fw-bold">Limit</label>
                                    <select id="filter-limit" class="form-control">
                                        <option value="50">50 records</option>
                                        <option value="200">200 records</option>
                                        <option value="1000">1000 records</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-primary w-100" onclick="fetchAuditLogs()">Search</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive audit-table-container">
                                <table class="table table-hover table-sm">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Agent</th>
                                            <th>Op</th>
                                            <th>Decision</th>
                                            <th>Reason</th>
                                            <th>ID</th>
                                        </tr>
                                    </thead>
                                    <tbody id="audit-logs-tbody">
                                        <tr><td colspan="6" class="text-center py-5">Enter filters to search audit trails</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Policies Tab -->
                <div id="content-policies" class="p-4 tab-content d-none">
                    <h3 class="fw-bold mb-4">Governance Policies</h3>
                    <div id="policies-content">
                        <!-- Polices will be loaded here -->
                        <div class="text-center py-5 text-muted">Loading active policies...</div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentUserApiKey = '';

        // Authentication logic
        function checkAuth() {
            const savedKey = localStorage.getItem('amg_api_key');
            if (savedKey) {
                currentUserApiKey = savedKey;
                document.getElementById('api-key-overlay').style.display = 'none';
                refreshAllData();
            }
        }

        function saveApiKey() {
            const key = document.getElementById('api-key-input').value;
            if (key) {
                localStorage.setItem('amg_api_key', key);
                currentUserApiKey = key;
                document.getElementById('api-key-overlay').style.display = 'none';
                refreshAllData();
            }
        }

        function logout() {
            localStorage.removeItem('amg_api_key');
            location.reload();
        }

        // Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
            document.getElementById('content-' + tabName).classList.remove('d-none');
            
            document.querySelectorAll('.sidebar .nav-link').forEach(el => el.classList.remove('active'));
            document.querySelector(`.sidebar .nav-link[onclick*="${tabName}"]`).classList.add('active');

            if (tabName === 'agents') fetchAgents();
            if (tabName === 'audit') fetchAuditLogs();
            if (tabName === 'policies') fetchPolicies();
        }

        // Data fetching
        async function apiFetch(endpoint, method = 'GET', body = null) {
            const options = {
                method: method,
                headers: {
                    'X-API-Key': currentUserApiKey,
                    'Content-Type': 'application/json'
                }
            };
            if (body) options.body = JSON.stringify(body);

            try {
                const response = await fetch(endpoint, options);
                if (response.status === 401 || response.status === 403) {
                    alert('Authentication failed. Please re-enter API key.');
                    logout();
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }

        async function refreshAllData() {
            await fetchSummary();
            await fetchAuditLogs(5);
            await fetchCertStatus();
        }

        async function fetchSummary() {
            const stats = await apiFetch('/stats/memory-summary');
            if (!stats) return;

            document.getElementById('stat-total-memories').innerText = stats.total_memories || 0;
            
            // Distributions
            const total = stats.total_memories || 1;
            const ltCount = stats.by_type.long_term || 0;
            const stCount = stats.by_type.short_term || 0;
            const epCount = stats.by_type.episodic || 0;

            document.getElementById('dist-lt-bar').style.width = (ltCount/total*100) + '%';
            document.getElementById('dist-lt-text').innerText = Math.round(ltCount/total*100) + '%';
            
            document.getElementById('dist-st-bar').style.width = (stCount/total*100) + '%';
            document.getElementById('dist-st-text').innerText = Math.round(stCount/total*100) + '%';

            document.getElementById('dist-ep-bar').style.width = (epCount/total*100) + '%';
            document.getElementById('dist-ep-text').innerText = Math.round(epCount/total*100) + '%';

            document.getElementById('dist-pii-count').innerText = stats.by_sensitivity.pii || 0;
            document.getElementById('dist-nonpii-count').innerText = stats.by_sensitivity.non_pii || 0;

            // Activity
            const activity = await apiFetch('/stats/agent-activity');
            if (activity) {
                document.getElementById('stat-active-agents').innerText = activity.summary.unique_agents || 0;
                document.getElementById('stat-audit-events').innerText = activity.summary.ops_last_24h || 0;
                
                let deniedCount = 0;
                if (activity.operation_distribution) {
                    const denied = activity.operation_distribution.find(d => d.name === 'denied');
                    deniedCount = denied ? denied.value : 0;
                }
                document.getElementById('stat-denied-ops').innerText = deniedCount;

                // Recent activity list
                const list = document.getElementById('recent-activity-list');
                list.innerHTML = '';
                activity.top_agents.forEach(agent => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center px-0';
                    li.innerHTML = `
                        <div>
                            <div class="fw-bold">${agent.agent_id}</div>
                            <div class="small text-muted">Last: ${new Date(agent.last_activity).toLocaleString()}</div>
                        </div>
                        <span class="badge bg-light text-dark rounded-pill">${agent.operations_count} ops</span>
                    `;
                    list.appendChild(li);
                });
            }
        }

        async function fetchAuditLogs(limitOverride = null) {
            const limit = limitOverride || document.getElementById('filter-limit').value;
            const agentId = document.getElementById('filter-agent') ? document.getElementById('filter-agent').value : '';
            const operation = document.getElementById('filter-op') ? document.getElementById('filter-op').value : '';
            
            let url = `/stats/audit-logs?limit=${limit}`;
            const data = await apiFetch(url);
            if (!data) return;

            const target = limitOverride ? 'home-audit-tbody' : 'audit-logs-tbody';
            const tbody = document.getElementById(target);
            tbody.innerHTML = '';

            data.logs.forEach(log => {
                const tr = document.createElement('tr');
                const decisionClass = log.decision === 'allowed' ? 'text-success' : 'text-danger fw-bold';
                tr.innerHTML = `
                    <td class="small text-muted">${new Date(log.timestamp).toLocaleTimeString()}</td>
                    <td class="small fw-bold">${log.agent_id}</td>
                    <td><span class="badge bg-light text-dark border">${log.operation}</span></td>
                    <td class="${decisionClass}">${log.decision}</td>
                    <td class="small text-muted">${log.reason}</td>
                    <td class="small text-muted font-monospace">${log.request_id ? log.request_id.substring(0,8) : '...'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function fetchAgents() {
            const config = await apiFetch('/config/agents');
            const grid = document.getElementById('agents-grid');
            if (!config) return;

            grid.innerHTML = '';
            config.agents.forEach(agent => {
                const div = document.createElement('div');
                div.className = 'col-md-4';
                const statusColor = agent.state === 'enabled' ? 'success' : 'danger';
                div.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <h5 class="fw-bold m-0">${agent.agent_id}</h5>
                                <span class="badge bg-${statusColor}">${agent.state}</span>
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-danger btn-sm" onclick="agentAction('${agent.agent_id}', 'disable')">Disable Agent</button>
                                <button class="btn btn-outline-warning btn-sm" onclick="agentAction('${agent.agent_id}', 'freeze')">Freeze Writes</button>
                                <button class="btn btn-outline-success btn-sm" onclick="agentAction('${agent.agent_id}', 'enable')">Enable/Reset</button>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        async function fetchPolicies() {
            const policies = await apiFetch('/config/policies');
            const target = document.getElementById('policies-content');
            if (!policies) return;

            target.innerHTML = `
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Memory Retention (Defaults)</div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <thead><tr><th>Type</th><th>TTL (Seconds)</th></tr></thead>
                                    <tbody>
                                        ${Object.entries(policies.default_ttls).map(([k, v]) => `<tr><td>${k}</td><td>${v.toLocaleString()}</td></tr>`).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Policy Constraints</div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    ${Object.entries(policies.policy_constraints).map(([k, v]) => `<li class="list-group-item d-flex justify-content-between"><span>${k}</span><span class="fw-bold">${v.toLocaleString()}</span></li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function fetchCertStatus() {
            const data = await apiFetch('/system/certificate-status');
            if (!data || data.error) return;
            
            document.getElementById('cert-status-text').innerText = 'Cert: ' + (data.certificate_info.notAfter ? 'Valid' : 'Unknown');
            document.getElementById('cert-expiry').innerText = 'Ends: ' + (data.certificate_info.notAfter || 'Unknown');
        }

        async function agentAction(agentId, action) {
            const reason = prompt(`Reason for ${action} agent ${agentId}:`, 'Operator manual override');
            if (reason === null) return;

            const res = await apiFetch(`/agent/${agentId}/${action}`, 'POST', { reason: reason });
            if (res) {
                alert(`Agent ${agentId} ${action}d successfully.`);
                fetchAgents();
                fetchAuditLogs();
            }
        }

        async function triggerGlobalShutdown() {
            if (!confirm('CRITICAL: This will disable ALL memory governance operations system-wide. Proceed?')) return;
            const reason = prompt('Reason for Global Shutdown:', 'Emergency maintenance');
            if (!reason) return;
            
            const res = await apiFetch('/system/shutdown', 'POST', { 
                reason: reason,
                actor_id: 'operator'
            });
            
            if (res) {
                alert('GLOBAL SHUTDOWN ACTIVATED: All agent memory operations are now disabled.');
                fetchAgents();
                refreshAllData();
            }
        }

        // Init
        window.onload = checkAuth;
    </script>
</body>
</html>