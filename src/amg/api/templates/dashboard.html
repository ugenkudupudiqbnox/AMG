<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>AMG Management UI</title>
    <!-- Tailwind CSS CDN -->
    <script src='https://cdn.tailwindcss.com'></script>
    <!-- Lucide Icons -->
    <script src='https://unpkg.com/lucide@latest'></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .tab-content.hidden { display: none; }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
    </style>
</head>
<body class='bg-zinc-50 text-zinc-950 min-h-screen'>

    <!-- API Key Entry Overlay -->
    <div id='api-key-overlay' class='fixed inset-0 bg-zinc-950/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-4'>
        <div class='bg-white border border-zinc-200 rounded-xl shadow-lg w-full max-w-md p-8'>
            <div class='text-center mb-6'>
                <div class='bg-zinc-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-zinc-600'>
                    <i data-lucide='shield-check' class='w-8 h-8'></i>
                </div>
                <h1 class='text-2xl font-bold tracking-tight'>AMG Governance</h1>
                <p class='text-zinc-500 text-sm mt-1'>Enter your operator API key to access the control plane.</p>
            </div>
            <div class='space-y-4'>
                <div class='space-y-2'>
                    <input type='password' id='api-key-input' class='w-full px-3 py-2 bg-white border border-zinc-200 rounded-md text-sm ring-offset-white focus:outline-none focus:ring-2 focus:ring-zinc-400' placeholder='sk-...'>
                </div>
                <button onclick='saveApiKey()' class='w-full bg-zinc-900 text-zinc-50 hover:bg-zinc-900/90 h-10 px-4 py-2 rounded-md text-sm font-medium transition-colors'>
                    Authenticate
                </button>
            </div>
        </div>
    </div>

    <div class='flex min-h-screen'>
        <!-- Sidebar -->
        <aside class='w-64 border-r border-zinc-200 bg-white hidden md:flex flex-col flex-shrink-0'>
            <div class='p-6 border-b border-zinc-100'>
                <div class='flex items-center gap-2'>
                    <div class='bg-zinc-900 text-white rounded p-1'>
                        <i data-lucide='database' class='w-5 h-5'></i>
                    </div>
                    <span class='font-bold text-lg tracking-tight'>AMG <span class='text-zinc-500 font-medium'>Plane</span></span>
                </div>
            </div>
            <nav class='flex-1 p-4 space-y-1'>
                <button onclick="showTab('dashboard')" id='nav-dashboard' class='nav-link w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md transition-colors bg-zinc-100 text-zinc-950'>
                    <i data-lucide='layout-dashboard' class='w-4 h-4'></i>
                    Dashboard
                </button>
                <button onclick="showTab('agents')" id='nav-agents' class='nav-link w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md transition-colors text-zinc-600 hover:bg-zinc-50 hover:text-zinc-950'>
                    <i data-lucide='cpu' class='w-4 h-4'></i>
                    Agents
                </button>
                <button onclick="showTab('audit')" id='nav-audit' class='nav-link w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md transition-colors text-zinc-600 hover:bg-zinc-50 hover:text-zinc-950'>
                    <i data-lucide='clipboard-list' class='w-4 h-4'></i>
                    Audit Explorer
                </button>
                <button onclick="showTab('policies')" id='nav-policies' class='nav-link w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md transition-colors text-zinc-600 hover:bg-zinc-50 hover:text-zinc-950'>
                    <i data-lucide='scroll-text' class='w-4 h-4'></i>
                    Policies
                </button>
                <div class='pt-4 mt-4 border-t border-zinc-100'>
                    <button onclick='logout()' class='w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-red-600 hover:bg-red-50 transition-colors'>
                        <i data-lucide='log-out' class='w-4 h-4'></i>
                        Logout
                    </button>
                </div>
            </nav>
            <div class='p-6 border-t border-zinc-100 text-[10px] text-zinc-400 uppercase tracking-widest font-bold'>
                Governance v1.0.0
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class='flex-1 flex flex-col min-w-0 h-screen overflow-hidden'>
            <!-- Top Navbar -->
            <header class='h-16 border-b border-zinc-200 bg-white flex items-center justify-between px-8 sticky top-0 z-40 flex-shrink-0'>
                <div class='flex items-center gap-4'>
                    <span id='tab-title' class='text-xs font-bold text-zinc-400 uppercase tracking-widest'>System Overview</span>
                </div>
                <div class='flex items-center gap-6'>
                    <div class='flex items-center gap-2'>
                        <label class='text-[10px] text-zinc-400 font-bold uppercase tracking-wider'>auto-refresh:</label>
                        <select id='auto-refresh-select' onchange='updateRefreshInterval()' class='bg-transparent text-xs font-bold focus:outline-none border-b border-zinc-200 pb-0.5 outline-none cursor-pointer'>
                            <option value='0'>Off</option>
                            <option value='1000'>1s</option>
                            <option value='5000'>5s</option>
                            <option value='10000'>10s</option>
                            <option value='30000'>30s</option>
                            <option value='60000'>60s</option>
                        </select>
                    </div>
                    <div class='hidden lg:flex flex-col items-end border-l border-zinc-200 pl-6 h-8 justify-center'>
                        <div class='text-[11px] font-bold text-zinc-900 leading-none tabular-nums' id='cert-status-text'>Cert: Valid</div>
                        <div class='text-[10px] text-zinc-400 leading-none mt-1 tabular-nums' id='cert-expiry'>Expires in -- days</div>
                    </div>
                    <div class='flex items-center gap-2 bg-emerald-50 text-emerald-700 px-2 py-1 rounded border border-emerald-100'>
                        <span class='status-indicator bg-emerald-500 animate-pulse'></span>
                        <span class='text-[10px] font-bold uppercase tracking-tighter'>Live</span>
                    </div>
                </div>
            </header>

            <!-- Scrollable Content -->
            <div class='p-8 flex-1 overflow-y-auto space-y-8'>
                <!-- Dashboard Tab -->
                <div id='content-dashboard' class='tab-content space-y-8'>
                    <div class='flex items-center justify-between'>
                        <h2 class='text-3xl font-bold tracking-tight'>Metrics</h2>
                        <div class='flex gap-2'>
                            <button onclick='refreshAllData()' class='inline-flex items-center justify-center rounded-md text-sm font-medium border border-zinc-200 bg-white hover:bg-zinc-100 h-9 px-3 gap-2 transition-colors'>
                                <i data-lucide='rotate-cw' class='w-4 h-4 text-zinc-500'></i>
                                Refresh
                            </button>
                            <button onclick='triggerGlobalShutdown()' class='inline-flex items-center justify-center rounded-md text-sm font-medium bg-red-600 text-zinc-50 hover:bg-red-700 h-9 px-3 gap-2 transition-colors'>
                                <i data-lucide='power' class='w-4 h-4'></i>
                                Shutdown
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4'>
                        <div class='rounded-xl border border-zinc-200 bg-white p-6 shadow-sm'>
                            <div class='flex items-center gap-2 text-zinc-500 mb-2'>
                                <i data-lucide='layers' class='w-4 h-4'></i>
                                <span class='text-[10px] font-bold uppercase tracking-widest text-zinc-400'>Total Memories</span>
                            </div>
                            <div class='text-3xl font-bold tracking-tighter tabular-nums' id='stat-total-memories'>0</div>
                        </div>
                        <div class='rounded-xl border border-zinc-200 bg-white p-6 shadow-sm'>
                            <div class='flex items-center gap-2 text-zinc-500 mb-2'>
                                <i data-lucide='activity' class='w-4 h-4'></i>
                                <span class='text-[10px] font-bold uppercase tracking-widest text-zinc-400'>Active Agents</span>
                            </div>
                            <div class='text-3xl font-bold tracking-tighter tabular-nums' id='stat-active-agents'>0</div>
                        </div>
                        <div class='rounded-xl border border-zinc-200 bg-white p-6 shadow-sm'>
                            <div class='flex items-center gap-2 text-zinc-500 mb-2'>
                                <i data-lucide='list' class='w-4 h-4'></i>
                                <span class='text-[10px] font-bold uppercase tracking-widest text-zinc-400'>Audit Events (24h)</span>
                            </div>
                            <div class='text-3xl font-bold tracking-tighter tabular-nums' id='stat-audit-events'>0</div>
                        </div>
                        <div class='rounded-xl border border-zinc-200 bg-white p-6 shadow-sm border-l-4 border-l-red-500'>
                            <div class='flex items-center gap-2 text-zinc-500 mb-2'>
                                <i data-lucide='shield-alert' class='w-4 h-4 text-red-500'></i>
                                <span class='text-[10px] font-bold uppercase tracking-widest text-zinc-400'>Denied Ops</span>
                            </div>
                            <div class='text-3xl font-bold tracking-tighter text-red-600 tabular-nums' id='stat-denied-ops'>0</div>
                        </div>
                    </div>

                    <!-- Distributions -->
                    <div class='grid grid-cols-1 lg:grid-cols-3 gap-8'>
                        <div class='lg:col-span-1 border border-zinc-200 bg-white rounded-xl shadow-sm overflow-hidden flex flex-col'>
                            <div class='p-6 border-b border-zinc-100 flex items-center justify-between bg-zinc-50/10'>
                                <h3 class='font-bold text-[10px] uppercase tracking-widest text-zinc-400'>Memory Engine</h3>
                                <i data-lucide='pie-chart' class='w-4 h-4 text-zinc-400'></i>
                            </div>
                            <div class='p-6 space-y-6 flex-1'>
                                <div class='space-y-2'>
                                    <div class='flex justify-between text-[11px] font-bold uppercase tracking-wider'>
                                        <span class='text-zinc-400'>Long-term</span>
                                        <span id='dist-lt-text' class='text-zinc-950'>0%</span>
                                    </div>
                                    <div class='h-1.5 w-full bg-zinc-100 rounded-full overflow-hidden'>
                                        <div id='dist-lt-bar' class='h-full bg-zinc-900 transition-all duration-700 ease-in-out' style='width: 0%'></div>
                                    </div>
                                </div>
                                <div class='space-y-2'>
                                    <div class='flex justify-between text-[11px] font-bold uppercase tracking-wider'>
                                        <span class='text-zinc-400'>Short-term</span>
                                        <span id='dist-st-text' class='text-zinc-950'>0%</span>
                                    </div>
                                    <div class='h-1.5 w-full bg-zinc-100 rounded-full overflow-hidden'>
                                        <div id='dist-st-bar' class='h-full bg-zinc-400 transition-all duration-700 ease-in-out' style='width: 0%'></div>
                                    </div>
                                </div>
                                <div class='space-y-2'>
                                    <div class='flex justify-between text-[11px] font-bold uppercase tracking-wider'>
                                        <span class='text-zinc-400'>Episodic</span>
                                        <span id='dist-ep-text' class='text-zinc-950'>0%</span>
                                    </div>
                                    <div class='h-1.5 w-full bg-zinc-100 rounded-full overflow-hidden'>
                                        <div id='dist-ep-bar' class='h-full bg-zinc-200 transition-all duration-700 ease-in-out' style='width: 0%'></div>
                                    </div>
                                </div>
                                <div class='grid grid-cols-2 pt-6 border-t border-zinc-100 divide-x divide-zinc-100'>
                                    <div class='text-center pr-3'>
                                        <div class='text-lg font-black tracking-tight' id='dist-pii-count'>0</div>
                                        <div class='text-[9px] font-bold text-red-500 uppercase mt-1 tracking-widest'>PII Assets</div>
                                    </div>
                                    <div class='text-center pl-3'>
                                        <div class='text-lg font-black tracking-tight' id='dist-nonpii-count'>0</div>
                                        <div class='text-[9px] font-bold text-emerald-600 uppercase mt-1 tracking-widest'>Compliant</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top Agents -->
                        <div class='lg:col-span-2 border border-zinc-200 bg-white rounded-xl shadow-sm overflow-hidden flex flex-col'>
                            <div class='p-6 border-b border-zinc-100 flex items-center justify-between'>
                                <h3 class='font-bold text-[10px] uppercase tracking-widest text-zinc-400'>Network Throughput</h3>
                                <i data-lucide='zap' class='w-4 h-4 text-zinc-400'></i>
                            </div>
                            <div class='p-0 flex-1'>
                                <div id='recent-activity-list' class='divide-y divide-zinc-50'>
                                    <div class='p-12 text-center text-zinc-400 text-xs lowercase italic'>Establishing baseline...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audit Strip -->
                    <div class='border border-zinc-200 bg-white rounded-xl shadow-sm overflow-hidden'>
                        <div class='p-6 border-b border-zinc-100 flex items-center justify-between'>
                            <h3 class='font-bold text-[10px] uppercase tracking-widest text-zinc-400'>Operational Trace</h3>
                            <button onclick="showTab('audit')" class='text-[10px] font-black text-zinc-400 hover:text-zinc-950 uppercase tracking-widest transition-colors flex items-center gap-1 group'>Full Trace <i data-lucide='arrow-right' class='w-3 h-3 group-hover:translate-x-1 transition-transform'></i></button>
                        </div>
                        <div class='overflow-x-auto'>
                            <table class='w-full text-left'>
                                <thead class='text-[10px] text-zinc-400 uppercase bg-zinc-50/50 border-b border-zinc-100'>
                                    <tr>
                                        <th class='px-6 py-4 font-bold'>Time</th>
                                        <th class='px-6 py-4 font-bold'>Agent</th>
                                        <th class='px-6 py-4 font-bold text-center'>Op</th>
                                        <th class='px-6 py-4 font-bold text-center'>State</th>
                                        <th class='px-6 py-4 font-bold'>Reason</th>
                                        <th class='px-6 py-4 font-bold text-right'>Reference</th>
                                    </tr>
                                </thead>
                                <tbody id='home-audit-tbody' class='divide-y divide-zinc-50 text-xs text-zinc-600 font-medium'>
                                    <tr><td colspan='6' class='px-6 py-12 text-center text-zinc-400 italic'>Syncing...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Agents Tab -->
                <div id='content-agents' class='tab-content hidden space-y-8'>
                    <div class='flex items-center justify-between'>
                        <h2 class='text-3xl font-bold tracking-tight'>Active Nodes</h2>
                        <button onclick='fetchAgents()' class='h-9 px-4 border border-zinc-200 bg-white rounded-md text-sm font-medium hover:bg-zinc-50 flex items-center gap-2 transition-colors'>
                            <i data-lucide='refresh-ccw' class='w-4 h-4 text-zinc-500'></i>
                            Reload
                        </button>
                    </div>

                    <div id='agents-progress' class='hidden h-1 w-full bg-zinc-100 overflow-hidden rounded-full mb-8'>
                        <div class='h-full bg-zinc-900 animate-[loading_1s_infinite] origin-left'></div>
                    </div>

                    <div id='agents-grid' class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6'>
                        <div class='col-span-full py-20 text-center text-zinc-400 italic text-sm'>Identifying active instances...</div>
                    </div>
                </div>

                <!-- Audit Explorer Tab -->
                <div id='content-audit' class='tab-content hidden space-y-8'>
                    <h2 class='text-3xl font-bold tracking-tight'>Forensic Log</h2>

                    <div class='bg-white border border-zinc-200 rounded-xl p-6 shadow-sm'>
                        <div class='grid grid-cols-1 md:grid-cols-12 gap-6'>
                            <div class='md:col-span-4 space-y-2'>
                                <label class='text-[10px] font-bold text-zinc-400 uppercase tracking-widest'>Identity</label>
                                <input type='text' id='filter-agent' class='w-full h-10 px-3 bg-zinc-50 border border-zinc-200 rounded-md text-sm focus:ring-1 focus:ring-zinc-400 outline-none transition-all font-mono' placeholder='agent-*'>
                            </div>
                            <div class='md:col-span-4 space-y-2'>
                                <label class='text-[10px] font-bold text-zinc-400 uppercase tracking-widest'>Operation</label>
                                <select id='filter-op' class='w-full h-10 px-3 bg-white border border-zinc-200 rounded-md text-sm focus:ring-1 focus:ring-zinc-400 outline-none transition-all cursor-pointer'>
                                    <option value=''>Universal</option>
                                    <option value='write'>Write Operations</option>
                                    <option value='read'>Read Operations</option>
                                    <option value='query'>Governance Query</option>
                                    <option value='disable'>Management Activity</option>
                                </select>
                            </div>
                            <div class='md:col-span-4 space-y-2'>
                                <label class='text-[10px] font-bold text-zinc-400 uppercase tracking-widest'>Page Size</label>
                                <select id='filter-limit' class='w-full h-10 px-3 bg-white border border-zinc-200 rounded-md text-sm focus:ring-1 focus:ring-zinc-400 outline-none transition-all cursor-pointer'>
                                    <option value='50'>50 Rows</option>
                                    <option value='200'>200 Rows</option>
                                    <option value='1000'>1000 Rows</option>
                                </select>
                            </div>

                            <div class='md:col-span-4 space-y-2'>
                                <label class='text-[10px] font-bold text-zinc-400 uppercase tracking-widest'>From</label>
                                <input type='datetime-local' id='filter-start' class='w-full h-10 px-3 bg-zinc-50 border border-zinc-200 rounded-md text-sm font-mono focus:ring-1 focus:ring-zinc-400 outline-none transition-all'>
                            </div>
                            <div class='md:col-span-4 space-y-2'>
                                <label class='text-[10px] font-bold text-zinc-400 uppercase tracking-widest'>To</label>
                                <input type='datetime-local' id='filter-end' class='w-full h-10 px-3 bg-zinc-50 border border-zinc-200 rounded-md text-sm font-mono focus:ring-1 focus:ring-zinc-400 outline-none transition-all'>
                            </div>
                            <div class='md:col-span-4 flex items-end gap-2'>
                                <button onclick='auditOffset=0; fetchAuditLogs()' class='flex-1 bg-zinc-950 text-white h-10 rounded-md text-xs font-bold uppercase tracking-widest hover:bg-zinc-800 transition-all shadow-sm'>Execute Search</button>
                                <button onclick="document.getElementById('filter-start').value=''; document.getElementById('filter-end').value=''; auditOffset=0; fetchAuditLogs()" class='px-4 border border-zinc-200 h-10 rounded-md text-zinc-500 hover:bg-zinc-50 transition-all' title='Clear Filters'><i data-lucide='x' class='w-4 h-4'></i></button>
                            </div>
                        </div>
                    </div>

                    <div id='audit-progress' class='hidden h-1 w-full bg-zinc-100 overflow-hidden rounded-full font-mono italic'>Scanning logs...</div>

                    <div class='border border-zinc-200 bg-white rounded-xl shadow-sm overflow-hidden flex flex-col'>
                        <div class='overflow-x-auto max-h-[600px] overflow-y-auto'>
                            <table class='w-full text-xs text-left'>
                                <thead class='text-[10px] text-zinc-400 uppercase bg-zinc-50/90 backdrop-blur-md sticky top-0 font-bold border-b border-zinc-100 z-10'>
                                    <tr>
                                        <th class='px-6 py-4'>Time (UTC)</th>
                                        <th class='px-6 py-4'>Identity</th>
                                        <th class='px-6 py-4 text-center'>Type</th>
                                        <th class='px-6 py-4 text-center'>Decision</th>
                                        <th class='px-6 py-4'>Logic</th>
                                        <th class='px-6 py-4 text-right'>Trace</th>
                                    </tr>
                                </thead>
                                <tbody id='audit-logs-tbody' class='divide-y divide-zinc-50 font-medium text-zinc-600'>
                                    <tr><td colspan='6' class='px-6 py-20 text-center text-zinc-400 italic font-mono lowercase tracking-tighter'>Forensic data stream idle.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class='px-6 py-4 bg-zinc-50/50 border-t border-zinc-100 flex items-center justify-between'>
                            <div class='text-[10px] font-black text-zinc-300 uppercase tracking-widest' id='audit-pagination-info'>Offset: 0 - Rows: 0</div>
                            <div class='flex items-center gap-1'>
                                <button onclick='changeAuditPage(-1)' id='audit-btn-prev' disabled class='h-8 px-4 border border-zinc-200 bg-white rounded text-[10px] font-black uppercase tracking-tighter hover:bg-zinc-50 disabled:opacity-30 transition-all'>Prev</button>
                                <button onclick='changeAuditPage(1)' id='audit-btn-next' disabled class='h-8 px-4 border border-zinc-200 bg-white rounded text-[10px] font-black uppercase tracking-tighter hover:bg-zinc-50 disabled:opacity-30 transition-all'>Next</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Policies Tab -->
                <div id='content-policies' class='tab-content hidden space-y-8'>
                    <div class='flex items-center justify-between'>
                        <h2 class='text-3xl font-bold tracking-tight'>Contract Logic</h2>
                        <div class='flex items-center gap-2 bg-emerald-950 text-white px-3 py-1 rounded text-[10px] font-black uppercase tracking-widest italic'>
                            <i data-lucide='verified' class='w-3 h-3'></i>
                            Hardened
                        </div>
                    </div>

                    <div id='policies-content' class='grid grid-cols-1 md:grid-cols-2 gap-8'>
                        <!-- Loaded via JS -->
                    </div>

                    <div class='p-6 border border-zinc-200 bg-zinc-100/30 rounded-xl text-xs text-zinc-400 font-medium italic text-center'>
                        <i data-lucide='info' class='inline-block w-3 h-3 mr-1 align-text-bottom'></i>
                        Goverance contracts are read-only. Policy-as-Code requires source control integration for all state modifications.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Animation Utilities -->
    <style>
        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        select { appearance: none; -webkit-appearance: none; }
    </style>

    <script>
        // Lucide Initializer
        window.addEventListener('DOMContentLoaded', () => lucide.createIcons());

        let currentUserApiKey = '';
        let refreshIntervalId = null;

        // Configuration Persistent Helpers
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for(let i=0;i < ca.length;i++) {
                let c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

        function updateRefreshInterval() {
            const val = document.getElementById('auto-refresh-select').value;
            setCookie('amg_refresh_interval', val, 30);
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            if (val > 0) refreshIntervalId = setInterval(refreshCurrentTab, parseInt(val));
        }

        function refreshCurrentTab() {
            const activeLink = document.querySelector('.nav-link.bg-zinc-100');
            if (activeLink) {
                const id = activeLink.id.replace('nav-', '');
                if (id === 'dashboard') { fetchSummary(); fetchAuditLogs(5, true); }
                else if (id === 'agents') { fetchAgents(true); }
                else if (id === 'audit') { fetchAuditLogs(null, true); }
            }
        }

        function checkAuth() {
            const savedKey = localStorage.getItem('amg_api_key');
            if (savedKey) {
                currentUserApiKey = savedKey;
                document.getElementById('api-key-overlay').classList.add('hidden', 'pointer-events-none');
                refreshAllData();
            }
        }

        function saveApiKey() {
            const key = document.getElementById('api-key-input').value;
            if (key) {
                localStorage.setItem('amg_api_key', key);
                currentUserApiKey = key;
                document.getElementById('api-key-overlay').classList.add('hidden', 'pointer-events-none');
                refreshAllData();
            }
        }

        function logout() {
            localStorage.removeItem('amg_api_key');
            location.reload();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('content-' + tabName).classList.remove('hidden');
            
            // Header Logic
            const labels = { dashboard: 'System Metrics', agents: 'Governance Units', audit: 'Forensic Explorer', policies: 'Hardened Contracts' };
            document.getElementById('tab-title').textContent = labels[tabName] || 'Overview';

            // Nav Highlighting
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('bg-zinc-100', 'text-zinc-950'));
            document.getElementById('nav-' + tabName).classList.add('bg-zinc-100', 'text-zinc-950');

            if (tabName === 'dashboard') { fetchSummary(); fetchAuditLogs(5); fetchCertStatus(); }
            if (tabName === 'agents') fetchAgents();
            if (tabName === 'audit') fetchAuditLogs();
            if (tabName === 'policies') fetchPolicies();
        }

        async function apiFetch(endpoint, method = 'GET', body = null) {
            const headers = { 'X-API-Key': currentUserApiKey, 'Content-Type': 'application/json' };
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            try {
                const res = await fetch(endpoint, options);
                if (res.status === 401 || res.status === 403) { logout(); return null; }
                return await res.json();
            } catch (e) { console.error('API Error:', e); return null; }
        }

        async function refreshAllData() {
            await Promise.all([fetchSummary(), fetchAuditLogs(5), fetchCertStatus()]);
            const savedInterval = getCookie('amg_refresh_interval');
            const select = document.getElementById('auto-refresh-select');
            if (savedInterval !== null) select.value = savedInterval;
            updateRefreshInterval();
        }

        async function fetchSummary() {
            const stats = await apiFetch('/stats/memory-summary');
            if (!stats) return;
            document.getElementById('stat-total-memories').innerText = (stats.total_memories || 0).toLocaleString();
            
            const total = stats.total_memories || 1;
            document.getElementById('dist-lt-bar').style.width = (stats.by_type.long_term/total*100) + '%';
            document.getElementById('dist-lt-text').innerText = Math.round(stats.by_type.long_term/total*100) + '%';
            document.getElementById('dist-st-bar').style.width = (stats.by_type.short_term/total*100) + '%';
            document.getElementById('dist-st-text').innerText = Math.round(stats.by_type.short_term/total*100) + '%';
            document.getElementById('dist-ep-bar').style.width = (stats.by_type.episodic/total*100) + '%';
            document.getElementById('dist-ep-text').innerText = Math.round(stats.by_type.episodic/total*100) + '%';
            document.getElementById('dist-pii-count').innerText = stats.by_sensitivity.pii || 0;
            document.getElementById('dist-nonpii-count').innerText = stats.by_sensitivity.non_pii || 0;

            const activity = await apiFetch('/stats/agent-activity');
            if (activity) {
                document.getElementById('stat-active-agents').innerText = activity.summary.unique_agents || 0;
                document.getElementById('stat-audit-events').innerText = activity.summary.ops_last_24h || 0;
                const denied = (activity.operation_distribution || []).find(d => d.name === 'denied');
                document.getElementById('stat-denied-ops').innerText = denied ? denied.value : 0;

                const list = document.getElementById('recent-activity-list');
                if (!activity.top_agents || activity.top_agents.length === 0) {
                    list.innerHTML = `<div class='p-12 text-center text-zinc-400 text-xs lowercase italic font-mono'>Quiescent state.</div>`;
                } else {
                    list.innerHTML = activity.top_agents.map(a => `
                        <div class='px-6 py-4 flex items-center justify-between hover:bg-zinc-50 transition-colors'>
                            <div class='flex items-center gap-4'>
                                <div class='h-9 w-9 bg-zinc-50 border border-zinc-200 rounded-lg flex items-center justify-center text-zinc-400'>
                                    <i data-lucide='shield-check' class='w-4 h-4 text-zinc-900 opacity-20'></i>
                                </div>
                                <div class='flex flex-col min-w-0'>
                                    <span class='text-xs font-black text-zinc-950 truncate max-w-[120px] lg:max-w-none font-mono uppercase tracking-tighter'>${a.agent_id}</span>
                                    <span class='text-[9px] font-bold text-zinc-400 uppercase tabular-nums tracking-widest'>${new Date(a.last_activity).toLocaleTimeString()} UTC</span>
                                </div>
                            </div>
                            <div class='text-right'>
                                <span class='text-sm font-black text-zinc-900 tabular-nums'>${a.operations_count.toLocaleString()}</span>
                                <span class='text-[9px] font-bold text-zinc-300 uppercase block tracking-tighter'>SIGNS</span>
                            </div>
                        </div>
                    `).join('');
                }
                lucide.createIcons();
            }
        }

        let auditOffset = 0;
        async function fetchAuditLogs(limitOverride = null, quiet = false) {
            const limit = limitOverride || document.getElementById('filter-limit').value;
            const agentId = document.getElementById('filter-agent')?.value || '';
            const op = document.getElementById('filter-op')?.value || '';
            const start = document.getElementById('filter-start')?.value || '';
            const end = document.getElementById('filter-end')?.value || '';
            
            if (!limitOverride && !quiet) document.getElementById('audit-progress').classList.remove('hidden');

            let url = `/stats/audit-logs?limit=${limit}&offset=${limitOverride ? 0 : auditOffset}`;
            if (!limitOverride) {
                if (agentId) url += `&agent_id=${agentId}`;
                if (op) url += `&operation=${op}`;
                if (start) url += `&start_time=${new Date(start).toISOString()}`;
                if (end) url += `&end_time=${new Date(end).toISOString()}`;
            }

            const data = await apiFetch(url);
            if (!limitOverride && !quiet) document.getElementById('audit-progress').classList.add('hidden');
            if (!data) return;

            const tbody = document.getElementById(limitOverride ? 'home-audit-tbody' : 'audit-logs-tbody');
            if (data.logs.length === 0) {
                tbody.innerHTML = `<tr><td colspan='6' class='px-6 py-12 text-center text-zinc-300 italic font-mono lowercase tracking-tighter'>End of stream.</td></tr>`;
            } else {
                tbody.innerHTML = data.logs.map(log => `
                    <tr class='hover:bg-zinc-50/70 transition-colors'>
                        <td class='px-6 py-4 font-mono text-[10px] text-zinc-400 tabular-nums'>${new Date(log.timestamp).toLocaleTimeString()}</td>
                        <td class='px-6 py-4 font-black text-zinc-950 uppercase tracking-tighter'>${log.agent_id}</td>
                        <td class='px-6 py-4 text-center'>
                            <span class='px-1.5 py-0.5 rounded-sm text-[8px] font-black uppercase tracking-widest ${log.operation === 'write' ? 'bg-zinc-950 text-white' : 'bg-zinc-100 text-zinc-500'}'>
                                ${log.operation}
                            </span>
                        </td>
                        <td class='px-6 py-4 text-center font-black uppercase text-[9px] italic tracking-widest ${log.decision === 'allowed' ? 'text-emerald-700' : 'text-red-500'}'>
                            ${log.decision}
                        </td>
                        <td class='px-6 py-4 text-[10px] leading-tight max-w-[200px] truncate opacity-80' title='${log.reason}'>${log.reason}</td>
                        <td class='px-6 py-4 text-right font-mono text-[9px] text-zinc-300 font-bold tabular-nums'>#${(log.request_id || '000').substring(0,8)}</td>
                    </tr>
                `).join('');
            }

            if (!limitOverride) {
                document.getElementById('audit-pagination-info').innerText = `OFFSET: ${auditOffset.toLocaleString()} | SCANNING: ${limit}`;
                document.getElementById('audit-btn-prev').disabled = (auditOffset === 0);
                document.getElementById('audit-btn-next').disabled = (data.logs.length < limit);
            }
        }

        function changeAuditPage(dir) {
            const limit = parseInt(document.getElementById('filter-limit').value);
            auditOffset = Math.max(0, auditOffset + (dir * limit));
            fetchAuditLogs();
        }

        async function fetchAgents(quiet = false) {
            if (!quiet) document.getElementById('agents-progress').classList.remove('hidden');
            const data = await apiFetch('/config/agents');
            if (!quiet) document.getElementById('agents-progress').classList.add('hidden');
            const grid = document.getElementById('agents-grid');
            if (!data || !grid) return;

            grid.innerHTML = data.agents.length === 0 
                ? `<div class='col-span-full py-20 text-center text-zinc-300 italic font-mono lowercase'>Identifier stack empty.</div>`
                : data.agents.map(a => `
                    <div class='bg-white border border-zinc-200 rounded-xl p-6 shadow-sm flex flex-col justify-between hover:shadow-md hover:border-zinc-300 transition-all group'>
                        <div class='space-y-4'>
                            <div class='flex items-center justify-between'>
                                <div class='flex items-center gap-3 min-w-0'>
                                    <div class='w-9 h-9 border border-zinc-100 bg-zinc-50 rounded-lg flex items-center justify-center text-zinc-400 group-hover:bg-zinc-950 group-hover:text-white transition-colors duration-300'>
                                        <i data-lucide='${a.state === 'disabled' ? 'shield-off' : 'user-check'}' class='w-4 h-4'></i>
                                    </div>
                                    <span class='text-xs font-black text-zinc-950 font-mono uppercase tracking-tighter truncate'>${a.agent_id}</span>
                                </div>
                            </div>
                            <div class='flex items-center justify-between'>
                                <span class='text-[9px] font-black uppercase px-2 py-0.5 rounded-sm border ${a.state === 'disabled' ? 'bg-red-50 text-red-700 border-red-100' : 'bg-emerald-50 text-emerald-700 border-emerald-100'}' >${a.state}</span>
                                <span class='text-[9px] font-bold text-zinc-300 tracking-widest italic'>V.1.0</span>
                            </div>
                        </div>
                        <div class='grid grid-cols-1 gap-1.5 pt-6 mt-4 border-t border-zinc-50'>
                            <button onclick="agentAction('${a.agent_id}', 'enable')" class='h-9 text-[10px] font-black uppercase bg-zinc-950 text-white rounded hover:bg-zinc-800 transition-colors'>Re-Enable</button>
                            <div class='grid grid-cols-2 gap-1.5'>
                                <button onclick="agentAction('${a.agent_id}', 'freeze')" class='h-9 text-[10px] font-black uppercase bg-white border border-zinc-200 text-zinc-600 rounded hover:bg-zinc-50 transition-colors'>Freeze</button>
                                <button onclick="agentAction('${a.agent_id}', 'disable')" class='h-9 text-[10px] font-black uppercase bg-white border border-red-100 text-red-600 rounded hover:bg-red-50 transition-colors'>Revoke</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            lucide.createIcons();
        }

        async function fetchPolicies() {
            const data = await apiFetch('/config/policies');
            if (!data) return;
            document.getElementById('policies-content').innerHTML = `
                <div class='border border-zinc-200 bg-white rounded-xl overflow-hidden shadow-sm flex flex-col'>
                    <div class='px-5 py-4 bg-zinc-50/50 border-b border-zinc-100 flex items-center justify-between'>
                        <span class='text-[10px] font-black uppercase tracking-widest text-zinc-400'>Retention Logic (TTL)</span>
                        <i data-lucide='clock' class='w-4 h-4 text-zinc-300'></i>
                    </div>
                    <div class='p-5 flex-1'>
                        <table class='w-full text-xs'>
                            <tbody class='divide-y divide-zinc-50'>
                                ${Object.entries(data.ttl_rules).map(([k, v]) => `<tr><td class='py-3 text-zinc-400 uppercase font-black text-[9px] tracking-tight'>${k.replace(/_/g, ' ')}</td><td class='py-3 text-right font-black tabular-nums tracking-wider'>${v.toLocaleString()} <span class='text-zinc-300 italic'>SEC</span></td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class='border border-zinc-200 bg-white rounded-xl overflow-hidden shadow-sm flex flex-col'>
                    <div class='px-5 py-4 bg-zinc-50/50 border-b border-zinc-100 flex items-center justify-between'>
                        <span class='text-[10px] font-black uppercase tracking-widest text-zinc-400'>Traffic Tags</span>
                        <i data-lucide='tag' class='w-4 h-4 text-zinc-300'></i>
                    </div>
                    <div class='p-6 space-y-6 flex-1'>
                        <div>
                            <span class='text-[9px] font-bold text-red-500 uppercase block mb-3 tracking-widest font-black italic'>Restricted PII Patterns</span>
                            <div class='flex flex-wrap gap-1.5'>${data.sensitivity_tags.pii_patterns.map(p => `<span class='px-2 py-1 bg-red-50 text-red-600 border border-red-100 rounded text-[9px] font-black font-mono lowercase'>${p}</span>`).join('')}</div>
                        </div>
                        <div class='pt-6 border-t border-zinc-50'>
                            <span class='text-[9px] font-bold text-emerald-600 uppercase block mb-3 tracking-widest font-black italic'>Compliant Metadata Keys</span>
                            <div class='flex flex-wrap gap-1.5'>${data.sensitivity_tags.non_pii_patterns.map(p => `<span class='px-2 py-1 bg-emerald-50 text-emerald-700 border border-emerald-100 rounded text-[9px] font-black font-mono lowercase'>${p}</span>`).join('')}</div>
                        </div>
                    </div>
                </div>
                <div class='border border-zinc-200 bg-white rounded-xl overflow-hidden shadow-sm flex flex-col'>
                    <div class='px-5 py-4 bg-zinc-50/50 border-b border-zinc-100 flex items-center justify-between'>
                        <span class='text-[10px] font-black uppercase tracking-widest text-zinc-400'>Context Budgeting</span>
                        <i data-lucide='database' class='w-4 h-4 text-zinc-300'></i>
                    </div>
                    <div class='p-6 space-y-4 flex-1'>
                        <div class='flex justify-between items-center'><span class='text-xs font-bold text-zinc-400 uppercase tracking-tighter'>Hard Token Cap</span><span class='text-xs font-black tabular-nums font-mono'>${data.context_budget.max_tokens.toLocaleString()}</span></div>
                        <div class='flex justify-between items-center'><span class='text-xs font-bold text-zinc-400 uppercase tracking-tighter'>Maximum Memory Assets</span><span class='text-xs font-black tabular-nums font-mono'>${data.context_budget.max_memory_items.toLocaleString()}</span></div>
                    </div>
                </div>
                <div class='border border-zinc-200 bg-white rounded-xl overflow-hidden shadow-sm flex flex-col'>
                    <div class='px-5 py-4 bg-zinc-50/50 border-b border-zinc-100 flex items-center justify-between'>
                        <span class='text-[10px] font-black uppercase tracking-widest text-zinc-400'>Hardened Isolation</span>
                        <i data-lucide='shield' class='w-4 h-4 text-zinc-300'></i>
                    </div>
                    <div class='p-6 space-y-4 flex-1'>
                        <div class='flex justify-between items-center'><span class='text-xs font-bold text-zinc-400 uppercase tracking-tighter italic'>State Store</span><span class='px-2 py-0.5 bg-zinc-100 text-zinc-800 text-[9px] font-black uppercase italic rounded-sm'>PG-SQL HARDENED</span></div>
                        <div class='flex justify-between items-center'><span class='text-xs font-bold text-zinc-400 uppercase tracking-tighter italic'>Traffic Tunnel</span><span class='px-2 py-0.5 bg-zinc-950 text-white text-[9px] font-black uppercase italic rounded-sm'>TLS 1.3 / AES-256</span></div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        async function fetchCertStatus() {
            const data = await apiFetch('/system/certificate-status');
            if (data?.certificate_info?.notAfter) {
                document.getElementById('cert-status-text').innerText = 'ENCRYPTION: ACTIVE';
                document.getElementById('cert-expiry').innerText = 'EXPIRATION: ' + data.certificate_info.notAfter;
            }
        }

        async function agentAction(id, action) {
            const reason = prompt(`Governance justifcation for ${action.toUpperCase()} on ${id}:`, 'Operator Override');
            if (reason === null) return;
            const res = await apiFetch(`/agent/${id}/${action}`, 'POST', { reason });
            if (res) { fetchAgents(); fetchAuditLogs(); }
        }

        async function triggerGlobalShutdown() {
            if (!confirm('INITIATE EMERGENCY SYSTEM SHUTDOWN?')) return;
            const reason = prompt('Shutdown Justification:');
            if (!reason) return;
            await apiFetch('/system/shutdown', 'POST', { reason, actor_id: 'operator-1' });
            refreshAllData();
        }

        window.onload = checkAuth;
    </script>
</body>
</html>
